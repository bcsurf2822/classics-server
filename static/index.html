<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Search Demo</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      h1,
      h2 {
        color: #333;
        text-align: center;
      }
      .upload-container,
      .search-container {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
        background-color: #f9f9f9;
      }
      .upload-container:hover,
      .search-container:hover {
        border-color: #999;
      }
      .button {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }
      .button:hover {
        background-color: #45a049;
      }
      #file-name {
        margin-top: 10px;
        font-style: italic;
      }
      #upload-status,
      #search-status {
        margin-top: 20px;
        padding: 10px;
        border-radius: 5px;
        display: none;
      }
      .success {
        background-color: #dff0d8;
        color: #3c763d;
      }
      .error {
        background-color: #f2dede;
        color: #a94442;
      }
      .info {
        background-color: #d9edf7;
        color: #31708f;
      }
      .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        border-radius: 5px 5px 0 0;
      }
      .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 17px;
      }
      .tab button:hover {
        background-color: #ddd;
      }
      .tab button.active {
        background-color: #ccc;
      }
      .tabcontent {
        display: none;
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 5px 5px;
        animation: fadeEffect 1s;
      }
      @keyframes fadeEffect {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      #search-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 20px 0;
      }
      #search-input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      #index-select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      .search-results {
        margin-top: 20px;
      }
      .result-item {
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background-color: white;
      }
      .result-title {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 18px;
      }
      .result-score {
        color: #666;
        font-size: 14px;
      }
      .result-content {
        margin: 10px 0;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 2s linear infinite;
        margin: 0 auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <h1>Book Embeddings Demo</h1>

    <div class="tab">
      <button class="tablinks active" onclick="openTab(event, 'Upload')">
        Upload
      </button>
      <button class="tablinks" onclick="openTab(event, 'Search')">
        Search
      </button>
    </div>

    <div id="Upload" class="tabcontent" style="display: block">
      <div class="upload-container">
        <h2>Upload a Text File</h2>
        <p>Select a .txt file to add to the search index</p>

        <input
          type="file"
          id="file-input"
          accept=".txt"
          style="display: none"
        />
        <button class="button" id="select-file-btn">Select File</button>
        <div id="file-name"></div>

        <button class="button" id="upload-btn" style="display: none">
          Upload to Search Index
        </button>
      </div>

      <div id="upload-status"></div>
    </div>

    <div id="Search" class="tabcontent">
      <div class="search-container">
        <h2>Search Books</h2>
        <p>Enter a query to search across your indexed books</p>

        <form id="search-form">
          <select id="index-select" required>
            <option value="">Select an index...</option>
          </select>

          <input
            type="text"
            id="search-input"
            placeholder="Enter your search query..."
            required
          />

          <label>
            <input type="checkbox" id="vector-search" checked />
            Use vector search (more accurate but slower)
          </label>

          <button type="submit" class="button">Search</button>
        </form>

        <div class="loader" id="search-loader"></div>
      </div>

      <div id="search-status"></div>
      <div class="search-results" id="search-results"></div>
    </div>

    <script>
      // Tab functionality
      function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";

        // If switching to search tab, refresh the index list
        if (tabName === "Search") {
          loadIndexes();
        }
      }

      // Upload functionality
      document
        .getElementById("select-file-btn")
        .addEventListener("click", () => {
          document.getElementById("file-input").click();
        });

      document
        .getElementById("file-input")
        .addEventListener("change", (event) => {
          const file = event.target.files[0];
          if (file) {
            document.getElementById(
              "file-name"
            ).textContent = `Selected: ${file.name}`;
            document.getElementById("upload-btn").style.display =
              "inline-block";
          }
        });

      document
        .getElementById("upload-btn")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("file-input");
          const statusDiv = document.getElementById("upload-status");

          if (fileInput.files.length === 0) {
            showStatus("Please select a file first.", "error");
            return;
          }

          const file = fileInput.files[0];
          if (!file.name.endsWith(".txt")) {
            showStatus("Only .txt files are supported.", "error");
            return;
          }

          const formData = new FormData();
          formData.append("file", file);

          try {
            showStatus("Uploading file...", "info");

            const response = await fetch("http://localhost:8000/upload-book", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (response.ok) {
              showStatus(
                `File uploaded successfully! Processing started for index: ${result.index_name}`,
                "success"
              );
              // Reset the form
              fileInput.value = "";
              document.getElementById("file-name").textContent = "";
              document.getElementById("upload-btn").style.display = "none";
            } else {
              showStatus(`Error: ${result.detail || "Unknown error"}`, "error");
            }
          } catch (error) {
            showStatus(`Error: ${error.message}`, "error");
          }
        });

      function showStatus(message, type) {
        const statusDiv = document.getElementById("upload-status");
        statusDiv.textContent = message;
        statusDiv.className = type;
        statusDiv.style.display = "block";
      }

      // Search functionality
      async function loadIndexes() {
        const selectElement = document.getElementById("index-select");
        const currentValue = selectElement.value;

        try {
          const response = await fetch("/indexes");
          if (response.ok) {
            const data = await response.json();

            // Clear existing options except the placeholder
            selectElement.innerHTML =
              "<option value=''>Select an index...</option>";

            // Add new options
            data.indexes.forEach((indexName) => {
              const option = document.createElement("option");
              option.value = indexName;
              option.textContent = indexName;
              selectElement.appendChild(option);
            });

            // Restore previously selected value if it exists
            if (currentValue && data.indexes.includes(currentValue)) {
              selectElement.value = currentValue;
            }
          } else {
            console.error("Failed to load indexes");
          }
        } catch (error) {
          console.error("Error loading indexes:", error);
        }
      }

      document
        .getElementById("search-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const query = document.getElementById("search-input").value.trim();
          const indexName = document.getElementById("index-select").value;
          const useVector = document.getElementById("vector-search").checked;

          if (!query) {
            showSearchStatus("Please enter a search query.", "error");
            return;
          }

          if (!indexName) {
            showSearchStatus("Please select an index.", "error");
            return;
          }

          try {
            // Show loader
            document.getElementById("search-loader").style.display = "block";
            document.getElementById("search-results").innerHTML = "";
            showSearchStatus("Searching...", "info");

            const response = await fetch(
              `/search?query=${encodeURIComponent(
                query
              )}&index_name=${encodeURIComponent(
                indexName
              )}&use_vector=${useVector}&top=5`
            );

            if (response.ok) {
              const data = await response.json();

              if (data.count === 0) {
                showSearchStatus("No results found.", "info");
              } else {
                showSearchStatus(`Found ${data.count} results.`, "success");

                const resultsContainer =
                  document.getElementById("search-results");
                resultsContainer.innerHTML = "";

                data.results.forEach((result) => {
                  const resultElement = document.createElement("div");
                  resultElement.className = "result-item";

                  const titleElement = document.createElement("div");
                  titleElement.className = "result-title";
                  titleElement.textContent = result.title;

                  const scoreElement = document.createElement("div");
                  scoreElement.className = "result-score";
                  scoreElement.textContent = `Score: ${result.score.toFixed(
                    2
                  )}`;

                  const contentElement = document.createElement("div");
                  contentElement.className = "result-content";
                  contentElement.textContent = result.content;

                  resultElement.appendChild(titleElement);
                  resultElement.appendChild(scoreElement);
                  resultElement.appendChild(contentElement);

                  resultsContainer.appendChild(resultElement);
                });
              }
            } else {
              const errorData = await response.json();
              showSearchStatus(
                `Error: ${errorData.detail || "Unknown error"}`,
                "error"
              );
            }
          } catch (error) {
            showSearchStatus(`Error: ${error.message}`, "error");
          } finally {
            // Hide loader
            document.getElementById("search-loader").style.display = "none";
          }
        });

      function showSearchStatus(message, type) {
        const statusDiv = document.getElementById("search-status");
        statusDiv.textContent = message;
        statusDiv.className = type;
        statusDiv.style.display = "block";
      }

      // Initial load of indexes
      document.addEventListener("DOMContentLoaded", () => {
        if (
          document.querySelector(".tablinks.active").textContent === "Search"
        ) {
          loadIndexes();
        }
      });
    </script>
  </body>
</html>
